# NEXUS CI Pipeline
# Runs tests, linting, and type checking on every PR and push to main
# Ensures code quality and prevents regressions before deployment

name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    PYTHON_VERSION: "3.11"
    NODE_VERSION: "20"

jobs:
    # Backend Tests & Linting
    backend:
        name: Backend Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: backend

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: nexus_test
                    POSTGRES_PASSWORD: nexus_test_password
                    POSTGRES_DB: nexus_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: "1.7.1"
                  virtualenvs-create: true
                  virtualenvs-in-project: true

            - name: Cache Poetry dependencies
              uses: actions/cache@v4
              with:
                  path: backend/.venv
                  key: venv-${{ runner.os }}-${{ hashFiles('backend/poetry.lock') }}
                  restore-keys: |
                      venv-${{ runner.os }}-

            - name: Install dependencies
              run: poetry install --no-interaction

            - name: Run Ruff linting
              run: poetry run ruff check .

            - name: Run Ruff formatting check
              run: poetry run ruff format --check .

            - name: Run MyPy type checking
              run: poetry run mypy app --ignore-missing-imports

            - name: Run Pytest with coverage
              env:
                  DATABASE_URL: postgresql+asyncpg://nexus_test:nexus_test_password@localhost:5432/nexus_test
                  ENVIRONMENT: testing
                  SECRET_KEY: test-secret-key-for-ci
              run: |
                  poetry run pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing

            - name: Upload coverage report
              uses: codecov/codecov-action@v4
              if: github.event_name == 'pull_request'
              with:
                  files: backend/coverage.xml
                  flags: backend
                  fail_ci_if_error: false

    # Frontend Tests & Linting
    frontend:
        name: Frontend Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: frontend

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Run TypeScript type check
              run: npm run type-check

            - name: Build application
              run: npm run build
              env:
                  NEXT_PUBLIC_API_URL: http://localhost:8000

    # Docker Build Validation
    docker-build:
        name: Docker Build Check
        runs-on: ubuntu-latest
        needs: [backend, frontend]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build backend image
              uses: docker/build-push-action@v5
              with:
                  context: ./backend
                  push: false
                  tags: nexus-backend:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build frontend image
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  push: false
                  tags: nexus-frontend:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # Security Scanning
    security:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: [backend, frontend]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  severity: "CRITICAL,HIGH"
                  exit-code: "1"
                  ignore-unfixed: true
